# codemotion25-loki

Choose your own Adventure with Grafana Loki. 

The [docker-compose.yaml](./docker-compose.yaml) file provided starts Loki, Grafana and uses the image [mingrammer/flog](https://github.com/mingrammer/flog) to generate logs.

Edit the [docker-compose.yaml](./docker-compose.yaml) file to choose the type of logs [mingrammer/flog](https://github.com/mingrammer/flog) generates. The default will be JSON format. To change the format to plain text, uncomment and comment the lines in the [docker-compose.yaml](./docker-compose.yaml) to change the command we pass the container to format `apache_common` instead of `json`.

```yaml
flog:
    image: mingrammer/flog:0.4.3
    ## JSON format
    #command: -f json -d 200ms -l
    ## plain text
    command: -f apache_common -d 200ms -l
    networks:
      - loki
```

And point Grafana Alloy configuration to 

```yaml
alloy:
    image: grafana/alloy:v1.8.3
    volumes:
      - ./alloy-local-config-apache-common.yaml:/etc/alloy/config.alloy:ro
      - /var/run/docker.sock:/var/run/docker.sock
```

## Ingest logs

```shell
docker compose up -d
```

The read component returns ready when you browse to http://localhost:3101/ready. The message `Query Frontend not ready: not ready: number of schedulers this worker is connected to is 0` shows until the read component is ready.

The write component returns ready when you browse to http://localhost:3102/ready. The message `Ingester not ready: waiting for 15s after being ready` shows until the write component is ready.

You can access the Grafana Alloy UI at http://localhost:12345.

## Query logs

Use Grafana to query the Loki data source.

The test environment includes [Grafana](https://grafana.com/docs/grafana/latest/), which you can use to query and observe the sample logs generated by the flog application.

You can access the Grafana cluster by browsing to http://localhost:3000.

The Grafana instance in this demonstration has a Loki [data source](https://grafana.com/docs/grafana/latest/datasources/loki/) already configured.

Use [Drilldown](https://grafana.com/docs/loki/latest/visualize/grafana/#logs-drilldown) or [Explore](https://grafana.com/docs/loki/latest/visualize/grafana/#grafana-explore)

## Clean-up

```shell
docker compose down -v
rm -rf logs
```
